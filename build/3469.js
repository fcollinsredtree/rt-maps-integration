"use strict";(globalThis.webpackChunkredtree_maps_integration=globalThis.webpackChunkredtree_maps_integration||[]).push([[3469],{36249:(e,t,i)=>{i.d(t,{X_:()=>o,i1:()=>a,zx:()=>l});var r=i(68628),s=i(84516);const n=96;function o(e,t){const i=t||e.extent,r=e.width,o=(0,s.GA)(i?.spatialReference);return i&&r?i.width/r*o*s.dy*n:0}function a(e,t){return e/((0,s.GA)(t)*s.dy*n)}function l(e,t,i){return function(e,t){return 0===t||(0,r.Sp)(e,t)||e<t}(e,t)&&function(e,t){return 0===t||(0,r.Sp)(e,t)||e>t}(e,i)}},35629:(e,t,i)=>{function r(e){const t=e.layer;return"floorInfo"in t&&t.floorInfo?.floorField&&"floors"in e.view?n(e.view.floors,t.floorInfo.floorField):null}function s(e,t){return"floorInfo"in t&&t.floorInfo?.floorField?n(e,t.floorInfo.floorField):null}function n(e,t){if(!e?.length)return null;const i=e.filter((e=>""!==e)).map((e=>`'${e}'`));return i.push("''"),`${t} IN (${i.join(",")}) OR ${t} IS NULL`}i.d(t,{E:()=>r,f:()=>s})},14542:(e,t,i)=>{i.d(t,{Sk:()=>n,Zx:()=>s,_X:()=>a});var r=i(28523);function s(e,t,i){const r=t.flatten((({sublayers:e})=>e)).length;return r!==e.length||!!e.some((e=>e.originIdOf("minScale")>i||e.originIdOf("maxScale")>i||e.originIdOf("renderer")>i||e.originIdOf("labelingInfo")>i||e.originIdOf("opacity")>i||e.originIdOf("labelsVisible")>i||e.originIdOf("source")>i))||!o(e,t)}function n(e,t,i){return!!e.some((e=>{const t=e.source,s=!t||"map-layer"===t.type&&t.mapLayerId===e.id&&(null==t.gdbVersion||t.gdbVersion===i);return e.commitProperty("renderer"),e.commitProperty("labelingInfo"),e.commitProperty("opacity"),e.commitProperty("labelsVisible"),!s||e.originIdOf("renderer")>r.Gr.SERVICE||e.originIdOf("labelingInfo")>r.Gr.SERVICE||e.originIdOf("opacity")>r.Gr.SERVICE||e.originIdOf("labelsVisible")>r.Gr.SERVICE}))||!o(e,t)}function o(e,t){if(!e?.length||null==t)return!0;const i=t.slice().reverse().flatten((({sublayers:e})=>e&&e.toArray().reverse())).map((e=>e.id)).toArray();if(e.length>i.length)return!1;let r=0;const s=i.length;for(const{id:t}of e){for(;r<s&&i[r]!==t;)r++;if(r>=s)return!1}return!0}function a(e){return!!e&&e.some((e=>null!=e.minScale||null!=e.layerDefinition?.minScale))}},38896:(e,t,i)=>{i.d(t,{j:()=>g});var r=i(41509),s=i(82555),n=i(16431),o=i(18552),a=i(73485),l=i(45543),u=i(85262),h=i(72848),d=i(34124),c=i(98770);class p{constructor(e,t,i){this._texture=null,this._lastTexture=null,this._fbos={},this.texelSize=4;const{buffer:r,pixelType:s,textureOnly:n}=e,o=(0,l.Qz)(s);this.blockIndex=i,this.pixelType=s,this.size=t,this.textureOnly=n,n||(this.data=new o(r)),this._resetRange()}destroy(){this._texture?.dispose();for(const e in this._fbos){const t=this._fbos[e];t&&("0"===e&&t.detachColorTexture(),t.dispose()),this._fbos[e]=null}this._texture=null}get _textureDesc(){const e=new c.R;return e.wrapMode=u.pF.CLAMP_TO_EDGE,e.samplingMode=u.Cj.NEAREST,e.dataType=this.pixelType,e.width=this.size,e.height=this.size,e}setData(e,t,i){const r=(0,a.Q4)(e),s=this.data,n=r*this.texelSize+t;!s||n>=s.length||(s[n]=i,this.dirtyStart=Math.min(this.dirtyStart,r),this.dirtyEnd=Math.max(this.dirtyEnd,r))}getData(e,t){if(null==this.data)return null;const i=(0,a.Q4)(e)*this.texelSize+t;return!this.data||i>=this.data.length?null:this.data[i]}getTexture(e){return this._texture??this._initTexture(e)}getFBO(e,t=0){if(!this._fbos[t]){const i=0===t?this.getTexture(e):this._textureDesc;this._fbos[t]=new h.H(e,i)}return this._fbos[t]}get hasDirty(){const e=this.dirtyStart;return this.dirtyEnd>=e}updateTexture(e,t){try{const i=this.dirtyStart,o=this.dirtyEnd;if(!this.hasDirty)return;(0,s.A)("esri-2d-update-debug")&&console.debug(`Version[${t}] AttributeStoreView.updateTexture`,{start:i,end:o,firstBytes:new Uint8Array(this.data.buffer.slice(0,16)),block:this}),this._resetRange();const a=this.data.buffer,u=this.getTexture(e),h=4,d=(i-i%this.size)/this.size,c=(o-o%this.size)/this.size,p=d,f=this.size,y=c,g=d*this.size*h,m=(f+y*this.size)*h-g,_=(0,l.Qz)(this.pixelType),b=new _(a,g*_.BYTES_PER_ELEMENT,m),x=this.size,w=y-p+1;if(w>this.size)return void n.A.getLogger("esri.views.2d.engine.webgl.AttributeStoreView").error(new r.A("mapview-webgl","Out-of-bounds index when updating AttributeData"));u.updateData(0,0,p,x,w,b)}catch(e){}}update(e){const{data:t,start:i,end:r}=e;if(null!=t&&null!=this.data){const r=this.data,s=i*this.texelSize;for(let i=0;i<t.length;i++){const n=1<<i%this.texelSize;e.layout&n&&(r[s+i]=t[i])}}this.dirtyStart=Math.min(this.dirtyStart,i),this.dirtyEnd=Math.max(this.dirtyEnd,r)}resize(e,t){const i=this.size;if(this.size=t,this.textureOnly)return void(i!==this.size&&(this._lastTexture=this._texture,this._texture=null));const r=(0,l.Qz)(this.pixelType);this.destroy(),this.data=new r(e.buffer)}_resetRange(){this.dirtyStart=2147483647,this.dirtyEnd=0}_initTexture(e){const t=new d.g(e,this._textureDesc,this.data??void 0);if(null!=this._lastTexture&&this._fbos[0]){const i=this._lastTexture.descriptor.width,r=this._lastTexture.descriptor.height,s=this._lastTexture.descriptor.dataType,n=this._lastTexture.descriptor.pixelFormat,o=this.getFBO(e),a=(0,l.AV)(s),u=new((0,l.Qz)(s))(new ArrayBuffer(i*r*a*this.texelSize)),h=e.getBoundFramebufferObject(),{x:d,y:c,width:p,height:f}=e.getViewport();e.bindFramebuffer(o),o.readPixels(0,0,i,r,n,s,u),t.updateData(0,0,0,2*i,r/2,u),e.setViewport(d,c,p,f),e.bindFramebuffer(h)}return this.destroy(),this._texture=t,this._texture}}class f{constructor(){this.size=0,this._pendingAttributeUpdates=[],this._version=0,this._epoch=0,this._locked=!1}_initialize(e){if(!e)throw new Error("InternalError: initArgs must be defined");const t=e.blockDescriptors;if(this.size=e.blockSize,(0,s.A)("esri-2d-update-debug")&&console.debug("AttributeStoreView.initialize",{message:e}),null==this._data)this._data=t.map(((e,t)=>null!=e?new p(e,this.size,t):null));else for(let e=0;e<this._data.length;e++){const i=this._data[e],r=t[e];null!=r&&(null==i?this._data[e]=new p(r,this.size,e):i.resize(r,this.size))}}destroy(){for(const e of this._data??[])e?.destroy();this._defaultTexture?.dispose(),this._defaultTexture=null,this._pendingAttributeUpdates=[]}isEmpty(){return null==this._data}getBlock(e){return null==this._data?null:this._data[e]}setLabelMinZoom(e,t){this.setData(e,0,1,t)}getLabelMinZoom(e){return this.getData(e,0,1,255)}getFilterFlags(e){return this.getData(e,0,0,0)}getVVSize(e){return this.getData(e,o.dV.VV,0,0)}getData(e,t,i,r){if(!this._data)return 0;const s=this._data[t];if(null==s)return 0;const n=s.getData(e,i);return null!=n?n:r}setData(e,t,i,r){this._data[t].setData(e,i,r)}lockTextureUploads(){this._locked=!0}unlockTextureUploads(){this._locked=!1,this.update()}requestUpdate(e){this._version=e.version,this._pendingAttributeUpdates.push(e),(0,s.A)("esri-2d-update-debug")&&console.debug(`Version[${this._version}] AttributeStoreView.requestUpdate`,{message:e})}get currentEpoch(){return this._epoch}update(){if(this._locked)return;const e=this._pendingAttributeUpdates;this._pendingAttributeUpdates=[];for(const t of e){const{blockData:e,initArgs:i,sendUpdateEpoch:r,version:n}=t;(0,s.A)("esri-2d-update-debug")&&console.debug(`Version[${this._version}] Epoch[${r}] AttributeStoreView.applyUpdate`),this._version=n,this._epoch=r,null!=i&&this._initialize(i);const o=this._data;for(let t=0;t<e.length;t++){const i=e[t],r=o[t];null!=r&&null!=i&&((0,s.A)("esri-2d-update-debug")&&console.debug(`Version[${this._version}] CpuBlock[${t}] AttributeStoreView.update`,{block:i}),r.update(i))}}}getUniforms(e){return{filterFlags:{texture:this._getTexture(e,o.dV.FilterFlags),unit:o.uM},animation:{texture:this._getTexture(e,o.dV.Animation),unit:o.z2},gpgpu:{texture:this._getTexture(e,o.dV.GPGPU),unit:o.Sr},visualVariableData:{texture:this._getTexture(e,o.dV.VV),unit:o.nM},dataDriven0:{texture:this._getTexture(e,o.dV.DD0),unit:o.lL},dataDriven1:{texture:this._getTexture(e,o.dV.DD1),unit:o.sn},dataDriven2:{texture:this._getTexture(e,o.dV.DD2),unit:o.n9},size:this.size}}_getTexture(e,t){const i=this._data?.[t];return i?(i.updateTexture(e,this._version),i.getTexture(e)):this._getDefaultTexture(e)}_getDefaultTexture(e){if(null==this._defaultTexture){const t=new c.R;t.wrapMode=u.pF.CLAMP_TO_EDGE,t.samplingMode=u.Cj.NEAREST,t.width=1,t.height=1,this._defaultTexture=new d.g(e,t,new Uint8Array(4))}return this._defaultTexture}}var y=i(37801);class g extends y.A{constructor(e){super(e),this._statisticsByLevel=new Map,this.attributeView=new f}destroy(){this.children.forEach((e=>e.destroy())),this.removeAllChildren(),this.attributeView.destroy()}doRender(e){e.context.capabilities.enable("textureFloatLinear"),super.doRender(e)}createRenderParams(e){const t=super.createRenderParams(e);return t.attributeView=this.attributeView,t.instanceStore=this._instanceStore,t.statisticsByLevel=this._statisticsByLevel,t}}},37801:(e,t,i)=>{i.d(t,{A:()=>u});var r=i(82555),s=i(93540),n=i(50262),o=i(39575),a=i(48248);const l=(e,t)=>e.key.level-t.key.level!=0?e.key.level-t.key.level:e.key.row-t.key.row!=0?e.key.row-t.key.row:e.key.col-t.key.col;class u extends n.A{constructor(e){super(),this._tileInfoView=e}renderChildren(e){this.sortChildren(l),this.setStencilReference(e),super.renderChildren(e)}createRenderParams(e){const{state:t}=e,i=super.createRenderParams(e);return i.requiredLevel=this._tileInfoView.getClosestInfoForScale(t.scale).level,i.displayLevel=this._tileInfoView.tileInfo.scaleToZoom(t.scale),i}prepareRenderPasses(e){const t=super.prepareRenderPasses(e);return t.push(e.registerRenderPass({name:"stencil",brushes:[o.A],drawPhase:s.S5.DEBUG|s.S5.MAP|s.S5.HIGHLIGHT|s.S5.LABEL,target:()=>this.getStencilTarget()})),(0,r.A)("esri-tiles-debug")&&t.push(e.registerRenderPass({name:"tileInfo",brushes:[a.A],drawPhase:s.S5.DEBUG,target:()=>this.children})),t}getStencilTarget(){return this.children}setStencilReference(e){let t=1;for(const e of this.children)e.stencilRef=t++}}},96749:(e,t,i)=>{i.d(t,{c:()=>s});var r=i(4359);class s{constructor(e,t,i){this._instanceId=e,this.techniqueRef=t,this._input=i}get instanceId(){return(0,r.P)(this._instanceId)}createMeshInfo(e){return{id:(0,r.P)(this._instanceId),techniqueType:this.techniqueRef.type,inputParams:e,optionalAttributes:this._input.optionalAttributes}}getInput(){return this._input}setInput(e){this._input=e}}},4359:(e,t,i)=>{function r(e){return e}function s(e){return e}i.d(t,{P:()=>r,U:()=>s})},73950:(e,t,i)=>{i.d(t,{f:()=>I});var r=i(18015),s=i(38896),n=i(93540),o=i(96749),a=i(12701),l=i(4359);let u=0;function h(e,t){return new o.c((0,l.U)(u++),e,t)}const d={visualVariableColor:null,visualVariableOpacity:null,visualVariableSizeMinMaxValue:null,visualVariableSizeScaleStops:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null,visualVariableRotation:null,visualVariableSizeOutlineScaleStops:null};class c{constructor(){this.instances={fill:h(a.YS.fill,{uniforms:d,optionalAttributes:{zoomRange:!0}}),marker:h(a.YS.marker,{uniforms:d,optionalAttributes:{zoomRange:!0}}),line:h(a.YS.line,{uniforms:d,optionalAttributes:{zoomRange:!0}}),text:h(a.YS.text,{uniforms:d,optionalAttributes:{zoomRange:!0,referenceSymbol:!1,clipAngle:!1}}),complexFill:h(a.YS.complexFill,{uniforms:d,optionalAttributes:{zoomRange:!0}}),texturedLine:h(a.YS.texturedLine,{uniforms:d,optionalAttributes:{zoomRange:!0}})},this._instancesById=Object.values(this.instances).reduce(((e,t)=>(e.set(t.instanceId,t),e)),new Map)}getInstance(e){return this._instancesById.get(e)}}var p=i(63051),f=i(93924),y=i(1065),g=i(55452),m=i(37519),_=i(2005),b=i(45543),x=i(70411),w=i(85262),v=i(81652);const S=Math.PI/180;class A extends _.q{constructor(e){super(),this._program=null,this._vao=null,this._vertexBuffer=null,this._indexBuffer=null,this._dvsMat3=(0,f.vt)(),this._localOrigin={x:0,y:0},this._getBounds=e}destroy(){this._vao&&(this._vao.dispose(),this._vao=null,this._vertexBuffer=null,this._indexBuffer=null),this._program=(0,r.WD)(this._program)}doRender(e){const{context:t}=e,i=this._getBounds();if(i.length<1)return;this._createShaderProgram(t),this._updateMatricesAndLocalOrigin(e),this._updateBufferData(t,i),t.setBlendingEnabled(!0),t.setDepthTestEnabled(!1),t.setStencilWriteMask(0),t.setStencilTestEnabled(!1),t.setBlendFunction(w.dn.ONE,w.dn.ONE_MINUS_SRC_ALPHA),t.setColorMask(!0,!0,!0,!0);const r=this._program;t.bindVAO(this._vao),t.useProgram(r),r.setUniformMatrix3fv("u_dvsMat3",this._dvsMat3),t.gl.lineWidth(1),t.drawElements(w.WR.LINES,8*i.length,w.pe.UNSIGNED_INT,0),t.bindVAO()}_createTransforms(){return{displayViewScreenMat3:(0,f.vt)()}}_createShaderProgram(e){this._program||(this._program=e.programCache.acquire("precision highp float;\n        uniform mat3 u_dvsMat3;\n\n        attribute vec2 a_position;\n\n        void main() {\n          mediump vec3 pos = u_dvsMat3 * vec3(a_position, 1.0);\n          gl_Position = vec4(pos.xy, 0.0, 1.0);\n        }","precision mediump float;\n      void main() {\n        gl_FragColor = vec4(0.75, 0.0, 0.0, 0.75);\n      }",M().attributes))}_updateMatricesAndLocalOrigin(e){const{state:t}=e,{displayMat3:i,size:r,resolution:s,pixelRatio:n,rotation:o,viewpoint:a}=t,l=S*o,{x:u,y:h}=a.targetGeometry,d=(0,m.mT)(u,t.spatialReference);this._localOrigin.x=d,this._localOrigin.y=h;const c=n*r[0],f=n*r[1],_=s*c,b=s*f,x=(0,p.D_)(this._dvsMat3);(0,p.lw)(x,x,i),(0,p.Tl)(x,x,(0,y.fA)(c/2,f/2)),(0,p.hs)(x,x,(0,g.fA)(r[0]/_,-f/b,1)),(0,p.e$)(x,x,-l)}_updateBufferData(e,t){const{x:i,y:r}=this._localOrigin,s=8*t.length,n=new Float32Array(s),o=new Uint32Array(8*t.length);let a=0,l=0;for(const e of t)e&&(n[2*a]=e[0]-i,n[2*a+1]=e[1]-r,n[2*a+2]=e[0]-i,n[2*a+3]=e[3]-r,n[2*a+4]=e[2]-i,n[2*a+5]=e[3]-r,n[2*a+6]=e[2]-i,n[2*a+7]=e[1]-r,o[l]=a+0,o[l+1]=a+3,o[l+2]=a+3,o[l+3]=a+2,o[l+4]=a+2,o[l+5]=a+1,o[l+6]=a+1,o[l+7]=a+0,a+=4,l+=8);if(this._vertexBuffer?this._vertexBuffer.setData(n.buffer):this._vertexBuffer=x.g.createVertex(e,w._U.DYNAMIC_DRAW,n.buffer),this._indexBuffer?this._indexBuffer.setData(o):this._indexBuffer=x.g.createIndex(e,w._U.DYNAMIC_DRAW,o),!this._vao){const t=M();this._vao=new v.Z(e,t.attributes,t.bufferLayouts,{geometry:this._vertexBuffer},this._indexBuffer)}}}const M=()=>(0,b.ES)("bounds",{geometry:[{location:0,name:"a_position",count:2,type:w.pe.FLOAT}]});class I extends s.j{constructor(e){super(e),this._instanceStore=new c,this.checkHighlight=()=>!0}destroy(){super.destroy(),this._boundsRenderer=(0,r.pR)(this._boundsRenderer)}get instanceStore(){return this._instanceStore}enableRenderingBounds(e){this._boundsRenderer=new A(e),this.requestRender()}get hasHighlight(){return this.checkHighlight()}onTileData(e,t){e.onMessage(t),this.contains(e)||this.addChild(e),this.requestRender()}_renderChildren(e,t){e.selection=t;for(const t of this.children){if(!t.visible)continue;const i=t.getDisplayList(this._instanceStore,n.ch.STRICT_ORDER);i?.render(e)}}}},5771:(e,t,i)=>{i.d(t,{A:()=>u});var r=i(71566),s=(i(16431),i(82555),i(1724),i(41509),i(37755)),n=i(93540),o=i(73950),a=i(52080);let l=class extends o.f{get hasHighlight(){return this.children.some((e=>e.hasData))}renderChildren(e){this.attributeView.update(),e.drawPhase===n.S5.HIGHLIGHT&&this.children.some((e=>e.hasData))&&(super.renderChildren(e),e.context.setColorMask(!0,!0,!0,!0),(0,a.lB)(e,!0,(e=>{this._renderChildren(e,n.RI.All)})))}};l=(0,r._)([(0,s.$)("esri.views.2d.layers.graphics.HighlightGraphicContainer")],l);const u=l},85071:(e,t,i)=>{i.d(t,{Uh:()=>X,ox:()=>W});var r=i(71566),s=i(90071),n=i(29985),o=i(36581),a=i(116),l=i(41509),u=i(61660),h=i(82555),d=i(60764),c=i(68617),p=i(45423),f=i(97127),y=i(84516),g=i(85464),m=(i(16431),i(37755)),_=i(93710),b=i(36249),x=i(44857),w=i(35629);function v(e,t){return t?"xoffset"in t&&t.xoffset?Math.max(e,Math.abs(t.xoffset)):"yoffset"in t&&t.yoffset?Math.max(e,Math.abs(t.yoffset||0)):e:e}function S(e,t){return"number"==typeof e?e:e?.stops?.length?function(e){let t=0,i=0;for(let r=0;r<e.length;r++){const s=e[r].size;"number"==typeof s&&(t+=s,i++)}return t/i}(e.stops):t}function A(e,t){if(!t)return e;const i=t.filter((e=>"size"===e.type)).map((t=>{const{maxSize:i,minSize:r}=t;return(S(i,e)+S(r,e))/2}));let r=0;const s=i.length;if(0===s)return e;for(let e=0;e<s;e++)r+=i[e];const n=Math.floor(r/s);return Math.max(n,e)}function M(e){const t=e?.renderer,i=e?.pointerType,r="touch"===i?9:6;if(!t)return r;const s="visualVariables"in t?A(r,t.visualVariables):r;if("simple"===t.type)return v(s,t.symbol);if("unique-value"===t.type){let e=s;return t.uniqueValueInfos?.forEach((t=>{e=v(e,t.symbol)})),e}if("class-breaks"===t.type){let e=s;return t.classBreakInfos.forEach((t=>{e=v(e,t.symbol)})),e}return"dot-density"===t.type||t.type,s}var I=i(18798),T=i(37519),R=i(28167),V=i(32191),E=i(57362),O=i(14542);function F(e,t){const{dpi:i,gdbVersion:r,geometry:s,geometryPrecision:n,height:o,historicMoment:a,layerOption:l,mapExtent:u,maxAllowableOffset:h,returnFieldName:d,returnGeometry:c,returnUnformattedValues:p,returnZ:y,spatialReference:g,timeExtent:m,tolerance:_,width:x}=e.toJSON(),{dynamicLayers:v,layerDefs:S,layerIds:A}=function(e){const{mapExtent:t,floors:i,width:r,sublayers:s,layerIds:n,layerOption:o,gdbVersion:a}=e,l=s?.find((e=>null!=e.layer))?.layer?.serviceSublayers,u="popup"===o,h={},d=(0,b.X_)({extent:t,width:r,spatialReference:t?.spatialReference}),c=[],p=e=>{const t=0===d,i=0===e.minScale||d<=e.minScale,r=0===e.maxScale||d>=e.maxScale;if(e.visible&&(t||i&&r))if(e.sublayers)e.sublayers.forEach(p);else{if(!1===n?.includes(e.id)||u&&(!e.popupTemplate||!e.popupEnabled))return;c.unshift(e)}};if(s?.forEach(p),s&&!c.length)h.layerIds=[];else{const e=(0,O.Sk)(c,l,a),t=c.map((e=>{const t=(0,w.f)(i,e);return e.toExportImageJSON(t)}));if(e)h.dynamicLayers=JSON.stringify(t);else{if(s){let e=c.map((({id:e})=>e));n&&(e=e.filter((e=>n.includes(e)))),h.layerIds=e}else n?.length&&(h.layerIds=n);const e=function(e,t){const i=!!e?.length,r=t.filter((e=>null!=e.definitionExpression||i&&null!=e.floorInfo));return r.length?r.map((t=>{const i=(0,w.f)(e,t),r=(0,f.m)(i,t.definitionExpression);return{id:t.id,definitionExpression:r??void 0}})):null}(i,c);if(null!=e&&e.length){const t={};for(const i of e)i.definitionExpression&&(t[i.id]=i.definitionExpression);Object.keys(t).length&&(h.layerDefs=JSON.stringify(t))}}}return h}(e),M=null!=t?.geometry?t.geometry:null,I={historicMoment:a,geometryPrecision:n,maxAllowableOffset:h,returnFieldName:d,returnGeometry:c,returnUnformattedValues:p,returnZ:y,tolerance:_},T=M?.toJSON()||s;I.imageDisplay=`${x},${o},${i}`,r&&(I.gdbVersion=r),T&&(delete T.spatialReference,I.geometry=JSON.stringify(T),I.geometryType=(0,V.$B)(T));const R=g??T?.spatialReference??u?.spatialReference;if(R&&(I.sr=(0,E.YX)(R)),I.time=m?[m.start,m.end].join(","):null,u){const{xmin:e,ymin:t,xmax:i,ymax:r}=u;I.mapExtent=`${e},${t},${i},${r}`}return S&&(I.layerDefs=S),v&&!S&&(I.dynamicLayers=v),I.layers="popup"===l?"visible":l,A&&!v&&(I.layers+=`:${A.join(",")}`),I}var P,z=i(29747),D=i(30474),G=i(37891),L=i(18082),B=(i(1724),i(35298)),k=i(62771);let U=P=class extends G.oY{static from(e){return(0,L.PZ)(P,e)}constructor(e){super(e),this.dpi=96,this.floors=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=null,this.height=400,this.historicMoment=null,this.layerIds=null,this.layerOption="top",this.mapExtent=null,this.maxAllowableOffset=null,this.returnFieldName=!0,this.returnGeometry=!1,this.returnM=!1,this.returnUnformattedValues=!0,this.returnZ=!1,this.spatialReference=null,this.sublayers=null,this.timeExtent=null,this.tolerance=null,this.width=400}writeHistoricMoment(e,t){t.historicMoment=e&&e.getTime()}};(0,r._)([(0,g.MZ)({type:Number,json:{write:!0}})],U.prototype,"dpi",void 0),(0,r._)([(0,g.MZ)()],U.prototype,"floors",void 0),(0,r._)([(0,g.MZ)({type:String,json:{write:!0}})],U.prototype,"gdbVersion",void 0),(0,r._)([(0,g.MZ)({types:z.yR,json:{read:V.rS,write:!0}})],U.prototype,"geometry",void 0),(0,r._)([(0,g.MZ)({type:Number,json:{write:!0}})],U.prototype,"geometryPrecision",void 0),(0,r._)([(0,g.MZ)({type:Number,json:{write:!0}})],U.prototype,"height",void 0),(0,r._)([(0,g.MZ)({type:Date})],U.prototype,"historicMoment",void 0),(0,r._)([(0,B.K)("historicMoment")],U.prototype,"writeHistoricMoment",null),(0,r._)([(0,g.MZ)({type:[Number],json:{write:!0}})],U.prototype,"layerIds",void 0),(0,r._)([(0,g.MZ)({type:["top","visible","all","popup"],json:{write:!0}})],U.prototype,"layerOption",void 0),(0,r._)([(0,g.MZ)({type:_.A,json:{write:!0}})],U.prototype,"mapExtent",void 0),(0,r._)([(0,g.MZ)({type:Number,json:{write:!0}})],U.prototype,"maxAllowableOffset",void 0),(0,r._)([(0,g.MZ)({type:Boolean,json:{write:!0}})],U.prototype,"returnFieldName",void 0),(0,r._)([(0,g.MZ)({type:Boolean,json:{write:!0}})],U.prototype,"returnGeometry",void 0),(0,r._)([(0,g.MZ)({type:Boolean,json:{write:!0}})],U.prototype,"returnM",void 0),(0,r._)([(0,g.MZ)({type:Boolean,json:{write:!0}})],U.prototype,"returnUnformattedValues",void 0),(0,r._)([(0,g.MZ)({type:Boolean,json:{write:!0}})],U.prototype,"returnZ",void 0),(0,r._)([(0,g.MZ)({type:k.A,json:{write:!0}})],U.prototype,"spatialReference",void 0),(0,r._)([(0,g.MZ)()],U.prototype,"sublayers",void 0),(0,r._)([(0,g.MZ)({type:D.A,json:{write:!0}})],U.prototype,"timeExtent",void 0),(0,r._)([(0,g.MZ)({type:Number,json:{write:!0}})],U.prototype,"tolerance",void 0),(0,r._)([(0,g.MZ)({type:Number,json:{write:!0}})],U.prototype,"width",void 0),U=P=(0,r._)([(0,m.$)("esri.rest.support.IdentifyParameters")],U);const N=U;var Z=i(89666),j=i(77069);let C=class extends G.oY{constructor(e){super(e),this.displayFieldName=null,this.feature=null,this.layerId=null,this.layerName=null}readFeature(e,t){return s.A.fromJSON({attributes:{...t.attributes},geometry:{...t.geometry}})}writeFeature(e,t){if(!e)return;const{attributes:i,geometry:r}=e;i&&(t.attributes={...i}),null!=r&&(t.geometry=r.toJSON(),t.geometryType=j.Y.toJSON(r.type))}};(0,r._)([(0,g.MZ)({type:String,json:{write:!0}})],C.prototype,"displayFieldName",void 0),(0,r._)([(0,g.MZ)({type:s.A})],C.prototype,"feature",void 0),(0,r._)([(0,Z.w)("feature",["attributes","geometry"])],C.prototype,"readFeature",null),(0,r._)([(0,B.K)("feature")],C.prototype,"writeFeature",null),(0,r._)([(0,g.MZ)({type:Number,json:{write:!0}})],C.prototype,"layerId",void 0),(0,r._)([(0,g.MZ)({type:String,json:{write:!0}})],C.prototype,"layerName",void 0),C=(0,r._)([(0,m.$)("esri.rest.support.IdentifyResult")],C);const H=C;function $(e){const t=e.data;return t.results=t.results||[],t.exceededTransferLimit=Boolean(t.exceededTransferLimit),t.results=t.results.map((e=>H.fromJSON(e))),t}var q=i(29385),Q=i(64437),Y=i(37634);let J=null;function W(e,t){return"tile"===t.type||"map-image"===t.type}let X=class extends n.A{constructor(e){super(e),this._featuresResolutions=new WeakMap,this.highlightGraphics=null,this.highlightGraphicUpdated=null,this.updateHighlightedFeatures=(0,c.sg)((async e=>{this.destroyed||this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(e).catch((()=>{})))}))}initialize(){const e=e=>{this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(e).catch((()=>{}))),this.updateHighlightedFeatures(this._highlightGeometriesResolution)};this.addHandles([(0,p.on)((()=>this.highlightGraphics),"change",(t=>e(t.added)),{onListenerAdd:t=>e(t)})])}async fetchPopupFeaturesAtLocation(e,t){const{layerView:{layer:i,view:{scale:r}}}=this;if(!e)throw new l.A("fetchPopupFeatures:invalid-area","Nothing to fetch without area",{layer:i});const s=function(e,t,i){const r=[];if(!e)return r;const s=e=>{const n=0===e.minScale||t<=e.minScale,o=0===e.maxScale||t>=e.maxScale;if(e.visible&&n&&o)if(e.sublayers)e.sublayers.forEach(s);else if(e.popupEnabled){const t=(0,Y.D8)(e,{...i,defaultPopupTemplateEnabled:!1});null!=t&&r.unshift({sublayer:e,popupTemplate:t})}};return e.map(s),r}(i.sublayers,r,t);if(!s.length)return[];const n=await async function(e,t){if(e.capabilities?.operations?.supportsQuery)return!0;try{return await Promise.any(t.map((({sublayer:e})=>e.load().then((()=>e.capabilities.operations.supportsQuery)))))}catch{return!1}}(i,s);if(!((i.capabilities?.operations?.supportsIdentify??1)&&i.version>=10.5||n))throw new l.A("fetchPopupFeatures:not-supported","query operation is disabled for this service",{layer:i});return n?this._fetchPopupFeaturesUsingQueries(e,s,t):this._fetchPopupFeaturesUsingIdentify(e,s,t)}clearHighlights(){this.highlightGraphics?.removeAll()}highlight(e){const t=this.highlightGraphics;if(!t)return(0,u.hA)();let i=null;if(e instanceof s.A?i=[e]:a.A.isCollection(e)&&e.length>0?i=e.toArray():Array.isArray(e)&&e.length>0&&(i=e),i=i?.filter(o.Ru),!i?.length)return(0,u.hA)();for(const e of i){const t=e.sourceLayer;null!=t&&"geometryType"in t&&"point"===t.geometryType&&(e.visible=!1)}return t.addMany(i),(0,u.hA)((()=>t.removeMany(i??[])))}async _updateHighlightedFeaturesSymbols(e){const{layerView:{view:t},highlightGraphics:r,highlightGraphicUpdated:s}=this;if(r&&s)for(const n of e){const e=n.sourceLayer&&"renderer"in n.sourceLayer&&n.sourceLayer.renderer;n.sourceLayer&&"geometryType"in n.sourceLayer&&"point"===n.sourceLayer.geometryType&&e&&"getSymbolAsync"in e&&e.getSymbolAsync(n).then((async o=>{o||=new Q.A;let a=null;const l="visualVariables"in e?e.visualVariables?.find((e=>"size"===e.type)):void 0;l&&(J||(J=(await Promise.resolve().then(i.bind(i,35123))).getSize),a=J(l,n,{view:t.type,scale:t.scale,shape:"simple-marker"===o.type?o.style:null})),a||="width"in o&&"height"in o&&null!=o.width&&null!=o.height?Math.max(o.width,o.height):"size"in o?o.size:16,r.includes(n)&&(n.symbol=new Q.A({style:"square",size:a,xoffset:"xoffset"in o?o.xoffset:0,yoffset:"yoffset"in o?o.yoffset:0}),s(n,"symbol"),n.visible=!0)}))}}async _updateHighlightedFeaturesGeometries(e){const{layerView:{layer:t,view:i},highlightGraphics:r,highlightGraphicUpdated:s}=this;if(this._highlightGeometriesResolution=e,!s||!r?.length||!t.capabilities.operations.supportsQuery)return;const n=this._getTargetResolution(e),o=new Map;for(const e of r)if(!this._featuresResolutions.has(e)||this._featuresResolutions.get(e)>n){const t=e.sourceLayer;(0,d.tE)(o,t,(()=>new Map)).set(e.getObjectId(),e)}const a=Array.from(o,(([e,t])=>{const r=e.createQuery();return r.objectIds=[...t.keys()],r.outFields=[e.objectIdField],r.returnGeometry=!0,r.maxAllowableOffset=n,r.outSpatialReference=i.spatialReference,e.queryFeatures(r)})),l=await Promise.all(a);if(!this.destroyed)for(const{features:e}of l)for(const t of e){const e=t.sourceLayer,i=o.get(e).get(t.getObjectId());i&&r.includes(i)&&(i.geometry=t.geometry,s(i,"geometry"),this._featuresResolutions.set(i,n))}}_getTargetResolution(e){const t=e*(0,y.GA)(this.layerView.view.spatialReference),i=t/16;return i<=10?0:e/t*i}async _fetchPopupFeaturesUsingIdentify(e,t,i){const r=await this._createIdentifyParameters(e,t,i);if(null==r)return[];const{results:s}=await async function(e,t,i){const r=(t=function(e){return N.from(e)}(t)).geometry?[t.geometry]:[],s=(0,R.Dl)(e);return s.path+="/identify",(0,T.el)(r).then((e=>{const r=F(t,{geometry:e?.[0]}),n=(0,R.lF)({...s.query,f:"json",...r}),o=(0,R.jV)(n,i);return(0,I.A)(s.path,o).then($).then((e=>function(e,t){if(!t?.length)return e;const i=new Map;t.forEach((function e(t){i.set(t.id,t),t.sublayers&&t.sublayers.forEach(e)}));for(const t of e.results)t.feature.sourceLayer=i.get(t.layerId);return e}(e,t.sublayers)))}))}(this.layerView.layer.parsedUrl,r,i);return s.map((e=>e.feature))}async _createIdentifyParameters(e,t,i){const{floors:r,layer:s,timeExtent:n,view:{spatialReference:o,scale:a}}=this.layerView;if(!t.length)return null;await Promise.all(t.map((({sublayer:e})=>e.load(i).catch((()=>{})))));const l=Math.min((0,h.A)("mapservice-popup-identify-max-tolerance"),s.allSublayers.reduce(((e,t)=>t.renderer?M({renderer:t.renderer,pointerType:i?.pointerType}):e),2)),u=this.createFetchPopupFeaturesQueryGeometry(e,l),d=(0,b.i1)(a,o),c=Math.round(u.width/d),p=new _.A({xmin:u.center.x-d*c,ymin:u.center.y-d*c,xmax:u.center.x+d*c,ymax:u.center.y+d*c,spatialReference:u.spatialReference});return new N({floors:r,gdbVersion:"gdbVersion"in s?s.gdbVersion:void 0,geometry:e,height:c,layerOption:"popup",mapExtent:p,returnGeometry:!0,spatialReference:o,sublayers:s.sublayers,timeExtent:n,tolerance:l,width:c})}async _fetchPopupFeaturesUsingQueries(e,t,i){const{layerView:{floors:r,timeExtent:s}}=this,n=t.map((async({sublayer:t,popupTemplate:n})=>{if(await t.load(i).catch((()=>{})),t.capabilities&&!t.capabilities.operations.supportsQuery)return[];const o=t.createQuery(),a=M({renderer:t.renderer,pointerType:i?.pointerType}),l=this.createFetchPopupFeaturesQueryGeometry(e,a),u=new Set,[h]=await Promise.all([(0,Y.TO)(t,n),t.renderer?.collectRequiredFields(u,t.fieldsIndex)]);(0,c.Te)(i),(0,x._w)(u,t.fieldsIndex,h);const d=Array.from(u).sort();o.geometry=l,o.outFields=d,o.timeExtent=s;const p=(0,w.f)(r,t);o.where=(0,f.m)(o.where,p);const y=this._getTargetResolution(l.width/a),g=await function(e){return e.expressionInfos?.length||Array.isArray(e.content)&&e.content.some((e=>"expression"===e.type))?(0,q.lw)():Promise.resolve()}(n);(0,c.Te)(i);const m="point"===t.geometryType||g&&g.arcadeUtils.hasGeometryOperations(n);m||(o.maxAllowableOffset=y);let{features:_}=await t.queryFeatures(o,i);const b=m?0:y;_=await async function(e,t,i){const r=e.renderer;return r&&"defaultSymbol"in r&&!r.defaultSymbol&&(t=r.valueExpression?await Promise.all(t.map((e=>r.getSymbolAsync(e,i).then((t=>t?e:null))))).then((e=>e.filter((e=>null!=e)))):t.filter((e=>null!=r.getSymbol(e)))),t}(t,_,i);for(const e of _)this._featuresResolutions.set(e,b);return _}));return(await Promise.allSettled(n)).reduce(((e,t)=>"fulfilled"===t.status?[...e,...t.value]:e),[]).filter(o.Ru)}};(0,r._)([(0,g.MZ)({constructOnly:!0})],X.prototype,"createFetchPopupFeaturesQueryGeometry",void 0),(0,r._)([(0,g.MZ)({constructOnly:!0})],X.prototype,"layerView",void 0),(0,r._)([(0,g.MZ)({constructOnly:!0})],X.prototype,"highlightGraphics",void 0),(0,r._)([(0,g.MZ)({constructOnly:!0})],X.prototype,"highlightGraphicUpdated",void 0),(0,r._)([(0,g.MZ)({constructOnly:!0})],X.prototype,"updatingHandles",void 0),X=(0,r._)([(0,m.$)("esri.views.layers.support.MapServiceLayerViewHelper")],X)},37634:(e,t,i)=>{i.d(t,{D8:()=>n,TO:()=>s});var r=i(44857);async function s(e,t=e.popupTemplate){if(null==t)return[];const i=await t.getRequiredFields(e.fieldsIndex),{lastEditInfoEnabled:s}=t,{objectIdField:n,typeIdField:o,globalIdField:a,relationships:l}=e;if(i.includes("*"))return["*"];const u=s?(0,r.eX)(e):[],h=(0,r.DB)(e.fieldsIndex,[...i,...u]);return o&&h.push(o),h&&n&&e.fieldsIndex?.has(n)&&!h.includes(n)&&h.push(n),h&&a&&e.fieldsIndex?.has(a)&&!h.includes(a)&&h.push(a),l&&l.forEach((t=>{const{keyField:i}=t;h&&i&&e.fieldsIndex?.has(i)&&!h.includes(i)&&h.push(i)})),h}function n(e,t){return e.popupTemplate?e.popupTemplate:null!=t&&t.defaultPopupTemplateEnabled&&null!=e.defaultPopupTemplate?e.defaultPopupTemplate:null}},24901:(e,t,i)=>{i.d(t,{V:()=>n}),i(29747);var r=i(84516),s=i(93710);function n(e,t,i,n=new s.A){let o=0;if("2d"===i.type)o=t*(i.resolution??0);else if("3d"===i.type){const s=i.overlayPixelSizeInMapUnits(e),n=i.basemapSpatialReference;o=null==n||n.equals(i.spatialReference)?t*s:(0,r.GA)(n)/(0,r.GA)(i.spatialReference)}const a=e.x-o,l=e.y-o,u=e.x+o,h=e.y+o,{spatialReference:d}=i;return n.xmin=Math.min(a,u),n.ymin=Math.min(l,h),n.xmax=Math.max(a,u),n.ymax=Math.max(l,h),n.spatialReference=d,n}new s.A}}]);